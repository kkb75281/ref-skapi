<template lang="pug">
#signup
    router-link(to="/")
        img(src="@/assets/img/logo/symbol-logo.png" alt="Skapi Logo" style="width: 40px; margin-bottom: .625rem")

    .page-title Sign Up

    hr

    form(@submit.prevent="signup")        
        label
            | Email
            input.block(type="email" 
            :value='form.email' 
            @input="e=> { form.email = e.target.value; }"
            placeholder="your@email.com" 
            required)


        label.passwordInput
            | Create Password
            input.block(:type='showPassword ? "text" : "password"'
            ref="passwordField" 
            @input="e=> { form.password = e.target.value; e.target.setCustomValidity(''); error = '' }"
            minlength="6"
            maxlength="60"
            placeholder="At least 6 characters" 
            required)
            //- .passwordIcon(@click="showPassword = !showPassword")
            //-     template(v-if="showPassword")
            //-         svg.svgIcon(style="fill: var(--black-6)")
            //-             use(xlink:href="/material-icon.svg?v=20250829065753667#icon-visibility-fill")
            //-     template(v-else)
            //-         svg.svgIcon(style="fill: var(--black-6)")
            //-             use(xlink:href="/material-icon.svg?v=20250829065753667#icon-visibility-off-fill")

        label.passwordInput
            | Confirm password
            input.block(:type='showPassword ? "text" : "password"'
            ref="confirmPasswordField" 
            @input="e=> { form.password_confirm = e.target.value; e.target.setCustomValidity(''); error = '' }"
            @change="validatePassword"
            placeholder="Enter your password again to confirm" 
            required)
            //- .passwordIcon(@click="showPassword = !showPassword")
            //-     template(v-if="showPassword")
            //-         svg.svgIcon(style="fill: var(--black-6)")
            //-             use(xlink:href="/material-icon.svg?v=20250829065753667#icon-visibility-fill")
            //-     template(v-else)
            //-         svg.svgIcon(style="fill: var(--black-6)")
            //-             use(xlink:href="/material-icon.svg?v=20250829065753667#icon-visibility-off-fill")

        .actions 
            Checkbox(v-model="form.subscribe" style='font-weight:unset;') I agree to receive newsletters from Skapi.

        br

        .error(v-if="error")
            svg
                use(xlink:href="/material-icon.svg?v=20250829065753667#icon-error")
            span {{ error }}
        
        br

        .bottom
            div(v-if="promiseRunning" style="width:100%; text-align:center")
                .loader(style="--loader-color:white; --loader-size:12px")

            template(v-else)
                button.inline Sign-up
                .signup 
                    | Have an account?&nbsp;
                    template(v-if="route.query.action")
                        RouterLink(:to="{ name: 'login', query: { action: route.query.action } }") Login
                    template(v-else-if="route.query.refer")
                        RouterLink(:to="{ name: 'login', query: { refer: route.query.refer } }") Login
                    template(v-else)
                        RouterLink(:to="{name: 'login'}") Login
                    //- RouterLink(:to="route.query.suc_redirect ? {name: 'login', query: { suc_redirect: route.query.suc_redirect }} : {name: 'login'}") Login
</template>

<script setup lang="ts">
import { useRoute, useRouter } from "vue-router";
import { skapi } from "@/main";
import { user } from "@/code/user";
import { onMounted, ref } from "vue";
import Checkbox from "@/components/checkbox.vue";

const router = useRouter();
const route = useRoute();

let showPassword = ref(false);
let promiseRunning = ref(false);
let passwordField = ref(null);
let confirmPasswordField = ref(null);
let error = ref(null);
let form = ref({
    email: "",
    password: "",
    password_confirm: "",
    subscribe: true,
});
let routeQuery = route.query;

onMounted(() => {

});

let validatePassword = () => {
    if (form.value.password_confirm !== form.value.password) {
        confirmPasswordField.value.setCustomValidity("Password does not match");
        confirmPasswordField.value.reportValidity();
    }
};

let signup = (e) => {
    error.value = "";
    promiseRunning.value = true;

    let miscValue = {
        affiliate_signup: null,
        refer: [],
    };

    if (routeQuery?.refer) {
        miscValue.affiliate_signup = routeQuery.refer;
        miscValue.refer.push(routeQuery.refer);
    }

    let params = {
        email: form.value.email,
        password: form.value.password,
        misc: JSON.stringify(miscValue),
    };

    let options = {
        signup_confirmation: "/success",
        email_subscription: form.value.subscribe,
    };

    if (routeQuery) {
        if (routeQuery?.refer) {
            options.signup_confirmation = "/success?refer=" + routeQuery.refer;
        } else {
            options.signup_confirmation = "/success";
        }

        if (routeQuery?.action) {
            options.signup_confirmation =
                options.signup_confirmation +
                "?action=" +
                routeQuery.action;
        }
    }

    skapi
        .signup(params, options)
        .then((res) => {
            router.push({
                path: "/confirmation",
                query: { email: form.value.email },
            });
        })
        .catch((err) => {
            promiseRunning.value = false;

            switch (err.code) {
                case "EXISTS":
                case "UsernameExistsException":
                    error.value = "This email is already in use";
                    break;
                default:
                    error.value =
                        "Something went wrong please contact an administrator.";
                    throw e;
            }
        });
};
</script>

<style scoped lang="less">
#signup {
    max-width: 480px;
    padding: 5rem 20px;
    margin: 0 auto;
    width: 100%;
}

form {
    padding: 8px;

    >label {
        margin-bottom: 16px;
    }

    .actions {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
    }

    .bottom {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        flex-direction: row-reverse;
        min-height: 44px;

        .signup {
            font-size: 16px;
            margin: 16px 0;
        }
    }
}

// .passwordInput {
//     position: relative;

//     .passwordIcon {
//         position: absolute;
//         right: 15px;
//         bottom: 10px;
//         opacity: 0.5;
//         cursor: pointer;
//     }
// }

@media (max-width: 480px) {
    form {
        .bottom {
            display: block;
            text-align: center;

            button {
                width: 100%;
            }

            .forgot {
                display: block;
                margin-bottom: 8px;
            }
        }
    }
}
</style>
